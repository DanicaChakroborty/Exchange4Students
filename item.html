<!DOCTYPE html>
<html>
<head>
    <title>Item Details - Student Marketplace</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .item-detail {
            display: flex;
            margin-top: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            color: #333;
        }
        
        .item-image {
            width: 300px;
            height: auto;
            object-fit: cover;
        }
        
        .item-info {
            padding: 20px;
            flex: 1;
        }
        
        .buy-actions {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .quantity-selector button {
            width: 30px;
            height: 30px;
            background-color: #cc0000;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        
        .quantity-selector input {
            width: 50px;
            height: 30px;
            text-align: center;
            margin: 0 10px;
        }
        
        .add-to-cart-btn {
            background-color: #cc0000;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .add-to-cart-btn:hover {
            background-color: #aa0000;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            display: none;
            z-index: 1000;
        }

        .badge {
            display: inline-block;
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Student Marketplace</h1>
        <div class="top-right">
            <button onclick="location.href='buyershub.html'" class="auth-btn">Home</button>
            <button onclick="viewCart()" class="auth-btn" id="cart-btn">Cart <span id="cart-count" class="badge">0</span></button>
            <button onclick="viewNotifications()" class="auth-btn" id="notifications-btn">Notifications <span id="notification-count" class="badge">0</span></button>
        </div>
    </div>

    <div class="content">
        <div id="item-container">
            <div class="loading">Loading item details...</div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Get item ID from URL
        function getItemId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Load item details
        function loadItem() {
            const itemId = getItemId();
            
            if (!itemId) {
                document.getElementById('item-container').innerHTML = `
                    <div class="loading" style="color: #f44336;">
                        Item ID not provided. <a href="buyershub.html">Return to marketplace</a>
                    </div>
                `;
                return;
            }
            
            fetch(`/api/items/${itemId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Item not found');
                    }
                    return response.json();
                })
                .then(item => {
                    document.title = `${item.title} - Student Marketplace`;
                    
                    const container = document.getElementById('item-container');
                    container.innerHTML = `
                        <div class="banner" style="font-weight: bold; font-size: 24px;">${item.title}</div>
                        <div class="item-detail">
                            <img src="${item.image_url || 'placeholder.jpg'}" alt="${item.title}" class="item-image">
                            <div class="item-info">
                                <p><strong>Price:</strong> $${item.price.toFixed(2)}</p>
                                <p><strong>Description:</strong> ${item.description}</p>
                                <p><strong>Category:</strong> ${item.category}</p>
                                <p><strong>Condition:</strong> ${item.condition}</p>
                                <p><strong>Seller:</strong> ${item.seller_name}</p>
                                
                                <div class="buy-actions">
                                    <div class="quantity-selector">
                                        <button onclick="decrementQuantity()">-</button>
                                        <input type="number" id="quantity" value="1" min="1" max="10">
                                        <button onclick="incrementQuantity()">+</button>
                                    </div>
                                    <button onclick="addToCart(${item.id})" class="add-to-cart-btn">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading item:', error);
                    document.getElementById('item-container').innerHTML = `
                        <div class="loading" style="color: #f44336;">
                            ${error.message || 'Error loading item details'}. <a href="buyershub.html">Return to marketplace</a>
                        </div>
                    `;
                });
        }
        
        // Check if user is logged in
        function checkAuth() {
            fetch('/api/user')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        // Not logged in, hide cart/notification buttons
                        document.getElementById('cart-btn').style.display = 'none';
                        document.getElementById('notifications-btn').style.display = 'none';
                        return null;
                    }
                })
                .then(data => {
                    if (data) {
                        // User is logged in, update counts
                        updateCartCount();
                        updateNotificationCount();
                    }
                    
                    // Load item regardless of login status
                    loadItem();
                })
                .catch(error => {
                    console.error('Authentication check error:', error);
                    loadItem(); // Still load item even if auth check fails
                });
        }
        
        // Update cart count
        function updateCartCount() {
            fetch('/api/cart')
                .then(response => response.json())
                .then(data => {
                    let count = 0;
                    if (data.items) {
                        count = data.items.reduce((sum, item) => sum + item.quantity, 0);
                    }
                    document.getElementById('cart-count').textContent = count;
                    document.getElementById('cart-count').style.display = count > 0 ? 'inline-block' : 'none';
                })
                .catch(error => {
                    console.error('Error updating cart count:', error);
                });
        }
        
        // Update notification count
        function updateNotificationCount() {
            fetch('/api/notifications/unread')
                .then(response => response.json())
                .then(data => {
                    const count = data.length;
                    document.getElementById('notification-count').textContent = count;
                    document.getElementById('notification-count').style.display = count > 0 ? 'inline-block' : 'none';
                })
                .catch(error => {
                    console.error('Error updating notification count:', error);
                });
        }
        
        // Increment quantity
        function incrementQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            if (currentValue < 10) {
                quantityInput.value = currentValue + 1;
            }
        }
        
        // Decrement quantity
        function decrementQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        }
        
        // Add item to cart
        function addToCart(itemId) {
            // Check if user is logged in
            fetch('/api/user')
                .then(response => {
                    if (!response.ok) {
                        alert('Please log in to add items to your cart');
                        window.location.href = '/login.html';
                        throw new Error('Not authenticated');
                    }
                    return response.json();
                })
                .then(data => {
                    const quantity = parseInt(document.getElementById('quantity').value);
                    
                    return fetch('/api/cart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ itemId, quantity })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to add to cart');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification('Item added to cart successfully!');
                    updateCartCount();
                })
                .catch(error => {
                    if (error.message !== 'Not authenticated') {
                        console.error('Error adding to cart:', error);
                        showNotification('Error adding to cart. Please try again.', 'error');
                    }
                });
        }
        
        // Show notification message
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            notification.style.display = 'block';
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // View cart
        function viewCart() {
            window.location.href = '/cart.html';
        }
        
        // View notifications
        function viewNotifications() {
            window.location.href = '/notifications.html';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>