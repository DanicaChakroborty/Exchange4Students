<!DOCTYPE html>
<html>
<head>
    <title>Buyer's Hub</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
        }

        .header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            padding: 15px;
        }

        .header h1 {
            margin: 0;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-btn {
            padding: 8px 12px;
        }

        #buyerSearch {
            padding: 8px;
            font-size: 14px;
        }

        .sidebar {
            float: left;
            width: 15%;
            padding: 20px;
        }

        .content {
            margin-left: 15%;
            padding: 20px;
        }

        .banner {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .item {
            width: 150px;
            text-align: center;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .item img {
            width: 100%;
            height: auto;
            margin-bottom: 8px;
        }

        /* CSS to remove link underline and maintain color */
        .item-link {
            text-decoration: none;
            color: inherit;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            display: none;
            z-index: 1000;
        }
        
        .badge {
            display: inline-block;
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Buyer's Hub</h1>
        <div class="top-right">
            <a href="index.html" class="auth-btn" style="text-decoration:none;">
                <button>Home</button>
            </a>
            <button onclick="viewCart()" class="auth-btn" id="cart-btn">Cart <span id="cart-count" class="badge">0</span></button>
            <button onclick="viewNotifications()" class="auth-btn" id="notifications-btn">Notifications <span id="notification-count" class="badge">0</span></button>
            <input type="text" id="buyerSearch" placeholder="Search items..." onkeyup="searchItems(event)">
        </div>
    </div>

    <div class="sidebar">
        <div class="banner">Categories</div>
        <ul>
            <li><a href="dorm.html">Dorm</a></li>
            <li><a href="athletics.html">Athletics</a></li>
            <li><a href="academics.html">Academics</a></li>
            <li><a href="clothes.html">Clothes</a></li>
            <li><a href="misc.html">Miscellaneous</a></li>
        </ul>
    </div>

    <div class="content">
        <div class="banner">Most Relevant Items</div>
        <div class="grid" id="buyerItems">
            <!-- Items will be loaded dynamically from the database -->
            <div id="loading">Loading items...</div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Check if user is logged in
        function checkAuth() {
            fetch('/api/user')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        // Not logged in, hide cart/notification buttons
                        document.getElementById('cart-btn').style.display = 'none';
                        document.getElementById('notifications-btn').style.display = 'none';
                        return null;
                    }
                })
                .then(data => {
                    if (data) {
                        // User is logged in, update counts
                        updateCartCount();
                        updateNotificationCount();
                    }
                    
                    // Load items regardless of login status
                    loadItems();
                })
                .catch(error => {
                    console.error('Authentication check error:', error);
                    loadItems(); // Still load items even if auth check fails
                });
        }
        
        // Load items from database
        function loadItems() {
            fetch('/api/items')
                .then(response => response.json())
                .then(items => {
                    const container = document.getElementById('buyerItems');
                    container.innerHTML = ''; // Clear loading
                    
                    if (items.length === 0) {
                        container.innerHTML = '<p>No items available at the moment.</p>';
                        return;
                    }
                    
                    items.forEach(item => {
                        const itemElement = document.createElement('a');
                        itemElement.href = `/item.html?id=${item.id}`;
                        itemElement.className = 'item-link';
                        
                        itemElement.innerHTML = `
                            <div class="item">
                                <img src="${item.image_url || 'placeholder.jpg'}" alt="${item.title}">
                                <div>${item.title} - $${item.price.toFixed(2)}</div>
                            </div>
                        `;
                        
                        container.appendChild(itemElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading items:', error);
                    document.getElementById('buyerItems').innerHTML = '<p>Error loading items. Please try again later.</p>';
                });
        }
        
        // Search items
        function searchItems(event) {
            // Prevent default form submission behavior when pressing Enter
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
            }
            
            const query = document.getElementById('buyerSearch').value.trim();
            
            if (query.length === 0) {
                loadItems(); // Load all items if search is empty
                return;
            }
            
            fetch(`/api/items/search/${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(items => {
                    const container = document.getElementById('buyerItems');
                    container.innerHTML = ''; // Clear previous results
                    
                    if (items.length === 0) {
                        container.innerHTML = '<p>No items found matching your search.</p>';
                        return;
                    }
                    
                    items.forEach(item => {
                        const itemElement = document.createElement('a');
                        itemElement.href = `/item.html?id=${item.id}`;
                        itemElement.className = 'item-link';
                        
                        itemElement.innerHTML = `
                            <div class="item">
                                <img src="${item.image_url || 'placeholder.jpg'}" alt="${item.title}">
                                <div>${item.title} - $${item.price.toFixed(2)}</div>
                            </div>
                        `;
                        
                        container.appendChild(itemElement);
                    });
                })
                .catch(error => {
                    console.error('Error searching items:', error);
                    document.getElementById('buyerItems').innerHTML = '<p>Error searching items. Please try again later.</p>';
                });
        }
        
        // Update cart count
        function updateCartCount() {
            fetch('/api/cart')
                .then(response => response.json())
                .then(data => {
                    let count = 0;
                    if (data.items) {
                        count = data.items.reduce((sum, item) => sum + item.quantity, 0);
                    }
                    document.getElementById('cart-count').textContent = count;
                    document.getElementById('cart-count').style.display = count > 0 ? 'inline-block' : 'none';
                })
                .catch(error => {
                    console.error('Error updating cart count:', error);
                });
        }
        
        // Update notification count
        function updateNotificationCount() {
            fetch('/api/notifications/unread')
                .then(response => response.json())
                .then(data => {
                    const count = data.length;
                    document.getElementById('notification-count').textContent = count;
                    document.getElementById('notification-count').style.display = count > 0 ? 'inline-block' : 'none';
                })
                .catch(error => {
                    console.error('Error updating notification count:', error);
                });
        }
        
        // View cart
        function viewCart() {
            window.location.href = '/cart.html';
        }
        
        // View notifications
        function viewNotifications() {
            window.location.href = '/notifications.html';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>